---
- name: Configure UFW on all hosts
  hosts: all
  become: yes
  tasks:
    - name: Install UFW if not present
      ansible.builtin.package:
        name: ufw
        state: present

    - name: Reset UFW to delete all rules (safe when inactive)
      ansible.builtin.command: ufw --force reset
      changed_when: true

    - name: Set default incoming policy to deny
      ansible.builtin.ufw:
        direction: incoming
        policy: deny

    - name: Allow SSH (port 22) from each inventory host
      ansible.builtin.ufw:
        rule: allow
        from_ip: "{{ hostvars[item].ansible_host }}"
        port: 22
        proto: tcp
      loop: "{{ groups['all'] }}"
      when: hostvars[item].ansible_host is defined

    - name: Allow port 11434 from each inventory host
      ansible.builtin.ufw:
        rule: allow
        from_ip: "{{ hostvars[item].ansible_host }}"
        port: 11434
        proto: tcp
      loop: "{{ groups['all'] }}"
      when: hostvars[item].ansible_host is defined

    - name: Enable UFW
      ansible.builtin.ufw:
        state: enabled
      register: ufw_enable

    - name: Debug final status
      ansible.builtin.command: ufw status verbose
      register: final_status
      changed_when: false

    - name: Show final UFW status
      ansible.builtin.debug:
        msg: "{{ final_status.stdout_lines }}"
